<!-- index.html (Client-side HTML, CSS, JavaScript) -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดเก็บเอกสาร</title>
    <!-- เชื่อมต่อกับไฟล์ Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --app-bg: #f0fdfa;
            --app-bg-pattern: #d1fae5;
            --sidebar-gradient-start: #34d399;
            --sidebar-gradient-end: #059669;
            --sidebar-text: #a7f3d0;
            --sidebar-text-hover: #ffffff;
            --active-menu-bg: #ffffff;
            --active-menu-text: #047857;
            --card-bg: #f0fdfa;
            --card-border: #d1fae5;
            --card-text: #065f46;
            --card-hover-bg: #10b981;
            --card-hover-text: #ffffff;
            --card-image-bg: #a7f3d0;
            --button-primary-bg: #10b981;
            --button-primary-hover-bg: #059669;
            --document-hover-border: #6ee7b7;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--app-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='var(--app-bg-pattern)' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }

        /* Login Screen Styles */
        .login-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .btn-google {
            background-color: #ffffff;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-google:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }
        .btn-email {
            background-color: var(--button-primary-bg);
            color: white;
        }
        .btn-email:hover {
            background-color: var(--button-primary-hover-bg);
        }
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
        }
        .login-input:focus {
            outline: none;
            border-color: var(--button-primary-bg);
            ring: 2px solid var(--button-primary-bg);
        }
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: #9ca3af;
            margin: 20px 0;
            font-size: 0.875rem;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .divider::before { margin-right: .5em; }
        .divider::after { margin-left: .5em; }

        /* Main layout for sidebar and content */
        .main-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* Mobile Header */
        .mobile-header {
            background: linear-gradient(90deg, var(--sidebar-gradient-start) 0%, var(--sidebar-gradient-end) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Sidebar styling */
        .sidebar {
            width: 280px; /* Fixed width for sidebar */
            background: linear-gradient(180deg, var(--sidebar-gradient-start) 0%, var(--sidebar-gradient-end) 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s ease;
            z-index: 50; /* Ensure above content on mobile */
        }
        .sidebar-header {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 40px;
            text-align: center;
            color: #ecfdf5; /* emerald-50 */
            letter-spacing: 1px;
        }
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            flex-grow: 1;
        }
        .sidebar-nav li {
            margin-bottom: 8px;
        }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }
        .sidebar-nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--sidebar-text-hover);
        }
        .sidebar-nav a.active {
            background-color: var(--active-menu-bg);
            color: var(--active-menu-text);
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2);
        }
        .sidebar-nav a .icon {
            width: 20px;
            height: 20px;
            stroke: var(--sidebar-text);
        }
        .sidebar-nav a:hover .icon {
            stroke: var(--sidebar-text-hover);
        }
        .sidebar-nav a.active .icon {
            stroke: var(--active-menu-text);
        }

        /* Main content area */
        .content-area {
            flex-grow: 1;
            padding: 40px;
        }
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 950px;
            margin: 0 auto;
        }
        
        /* Card specific styles */
        .menu-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 24px;
        }
        .menu-card {
            background-color: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            height: 70px;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15);
            background-color: var(--card-hover-bg);
        }
        .menu-card-image-wrapper {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background-color: var(--card-image-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .menu-card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .menu-card-text {
            font-weight: 600;
            color: var(--card-text);
            text-align: left;
            line-height: 1.4;
        }
        .menu-card:hover .menu-card-text {
            color: var(--card-hover-text);
        }

        /* Back button style */
        .btn-back {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        .btn-back:hover {
            background-color: #5a6268;
        }
        
        /* Document list style */
        #documentList .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        #documentList .document-item:hover {
            border-color: var(--document-hover-border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .btn-read {
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-read:hover {
            background-color: var(--button-primary-hover-bg);
        }

        /* Message Box styles */
        .message-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        /* Settings & About Me Page Styles */
        .setting-item, .profile-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 20px;
            border-radius: 12px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--button-primary-bg);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .theme-button.active {
            ring-width: 2px;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            --tw-ring-color: #374151; /* Use a consistent dark gray for the ring */
            --tw-ring-offset-width: 2px;
            --tw-ring-offset-color: #fff;
        }


        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            /* Sidebar as off-canvas menu */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                transform: translateX(-100%); /* Hidden by default */
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            
            .sidebar.open {
                transform: translateX(0); /* Slide in */
            }

            .sidebar-header {
                margin-bottom: 20px;
            }

            .content-area {
                padding: 15px;
                padding-top: 20px;
            }
            .container {
                padding: 20px;
            }
            
            /* Overlay */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                backdrop-filter: blur(2px);
            }
        }
    </style>
</head>
<body class="antialiased">
    
    <!-- Login Screen -->
    <div id="loginPage" class="login-wrapper">
        <div class="login-card">
            <div class="mb-6 flex justify-center">
                <div class="h-16 w-16 bg-emerald-100 rounded-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">เข้าสู่ระบบ</h2>
            <p class="text-gray-500 mb-6">ระบบจัดเก็บเอกสารอิเล็กทรอนิกส์</p>

            <form id="emailLoginForm">
                <input type="email" id="emailInput" placeholder="อีเมล (Email)" class="login-input" required>
                <input type="password" id="passwordInput" placeholder="รหัสผ่าน (Password)" class="login-input" required>
                <button type="submit" class="login-btn btn-email">
                    เข้าสู่ระบบ
                </button>
            </form>

            <div class="divider">หรือเข้าสู่ระบบด้วย</div>

            <button id="googleLoginBtn" class="login-btn btn-google">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Google Account
            </button>
            
            <p id="loginErrorMsg" class="mt-4 text-red-500 text-sm hidden"></p>
        </div>
    </div>

    <!-- Main App Layout (Hidden initially) -->
    <div id="mainLayout" class="main-layout hidden relative">
        <!-- Overlay for mobile sidebar -->
        <div id="sidebarOverlay" class="sidebar-overlay hidden md:hidden"></div>

        <!-- Mobile Header (Visible only on mobile) -->
        <div class="mobile-header md:hidden flex justify-between items-center p-4 text-white">
            <button id="mobileMenuBtn" class="p-2 rounded-md hover:bg-white/20 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <span class="font-bold text-lg">ระบบเอกสาร</span>
            <div class="w-8"></div> <!-- Spacer for visual balance -->
        </div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <!-- Close button for mobile -->
            <div class="md:hidden flex justify-end mb-2">
                <button id="closeSidebarBtn" class="text-white p-2 hover:bg-white/20 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <h1 class="sidebar-header">ระบบเอกสาร</h1>
            <div id="sidebar-nav-container" class="sidebar-nav">
                <!-- Sidebar items will be dynamically inserted here -->
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="content-area">
            <div class="container relative">
                <!-- User Profile / Logout -->
                <div class="absolute top-6 right-6 flex items-center gap-3">
                    <span id="userDisplay" class="text-sm font-medium text-gray-600 hidden md:block"></span>
                    <button id="logoutBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm transition">
                        ออกจากระบบ
                    </button>
                </div>

                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center" id="mainContentTitle"></h1>
                <div id="messageBox" class="message-box"></div> <!-- Message box added here -->
                <div id="mainContentDisplay" class="p-4">
                    <!-- Content will be loaded here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- ส่วนการตั้งค่า FIREBASE (ต้องแก้ไข) ---
        // 1. ไปที่ https://console.firebase.google.com/
        // 2. สร้าง Project ใหม่ หรือเลือก Project เดิม
        // 3. เมนู Project settings > General > Your apps > Web App (</>)
        // 4. นำค่า firebaseConfig มาแทนที่ด้านล่างนี้
        const firebaseConfig = {
            apiKey: "AIzaSyChLR9pMmY1QCgD2HjJ0GjTGS5mx6tG0N8",
            authDomain: "lnwlawyer.firebaseapp.com",
            projectId: "lnwlawyer",
            storageBucket: "lnwlawyer.firebasestorage.app",
            messagingSenderId: "105328800542",
            appId: "1:105328800542:web:69326f9bf2c77307548f0f"
        };

        // --- Initialize Firebase ---
        let auth;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
        } catch (e) {
            console.warn("Firebase not configured correctly. Using mock mode for UI preview.");
        }

        // --- DOM Elements ---
        const loginPage = document.getElementById('loginPage');
        const mainLayout = document.getElementById('mainLayout');
        const loginErrorMsg = document.getElementById('loginErrorMsg');
        const userDisplay = document.getElementById('userDisplay');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const emailLoginForm = document.getElementById('emailLoginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Mobile Menu Elements
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // --- Auth Logic ---
        
        // 1. Handle Auth State Change
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Login Success
                    showMainApp(user);
                } else {
                    // Logout / Not Logged in
                    showLoginScreen();
                }
            });
        } else {
            // Fallback if no firebase config (Show login but allow bypass for demo)
            loginErrorMsg.innerHTML = "กรุณาใส่ Firebase Config ในโค้ด (บรรทัด ~470)<br><span class='text-xs text-gray-400'>กำลังใช้โหมดแสดงตัวอย่าง</span>";
            loginErrorMsg.classList.remove('hidden');
            
            // Allow demo login
            emailLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                showMainApp({ email: "demo@user.com" });
            });
        }

        // 2. Login Functions
        async function handleGoogleLogin() {
            if (!auth) return alert("กรุณาตั้งค่า Firebase Config ก่อน");
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                showError("เกิดข้อผิดพลาดในการล็อกอินผ่าน Google: " + error.message);
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            if (!auth) return;
            
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error(error);
                let msg = "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
                if (error.code === 'auth/user-not-found') msg = "ไม่พบผู้ใช้งานนี้";
                if (error.code === 'auth/wrong-password') msg = "รหัสผ่านผิด";
                showError(msg);
            }
        }

        async function handleLogout() {
            if (auth) {
                await signOut(auth);
            } else {
                location.reload(); // Reload for demo mode
            }
        }

        // 3. UI Helper Functions
        function showMainApp(user) {
            loginPage.classList.add('hidden');
            mainLayout.classList.remove('hidden');
            userDisplay.textContent = user.email;
            
            // Start the original app logic
            if (!window.appInitialized) {
                initApp(); 
                window.appInitialized = true;
            }
        }

        function showLoginScreen() {
            mainLayout.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('emailInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        function showError(msg) {
            loginErrorMsg.textContent = msg;
            loginErrorMsg.classList.remove('hidden');
        }
        
        // --- Mobile Menu Logic ---
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
        }

        // --- Event Listeners ---
        googleLoginBtn.addEventListener('click', handleGoogleLogin);
        emailLoginForm.addEventListener('submit', handleEmailLogin);
        logoutBtn.addEventListener('click', handleLogout);
        
        // Mobile Menu Listeners
        if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleSidebar);
        if(closeSidebarBtn) closeSidebarBtn.addEventListener('click', toggleSidebar);
        if(sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);


        // ---------------------------------------------------------
        // --- ORIGINAL APPLICATION LOGIC (Adapted for Module) ---
        // ---------------------------------------------------------

        const mainContentDisplay = document.getElementById('mainContentDisplay');
        const mainContentTitle = document.getElementById('mainContentTitle');
        const sidebarNavContainer = document.getElementById('sidebar-nav-container');
        const messageBox = document.getElementById('messageBox');
        
        // --- GOOGLE SHEETS CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwG82PSvIQjy7Ujmab4btojXbgHp2ECYJ9Lm4G49rwnSQS-7I4TbQ-tAB9UCi5zKUsZ/exec';

        // --- DATA STORAGE ---
        let historyStack = [];
        let mainMenuData = [];
        let subMenuData = {};
        let documentData = {};
        const defaultImageUrl = "https://placehold.co/100x100/d1fae5/065f46?text=%3F";

        const ICONS = {
            home: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`,
            law: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.121 15.536c-1.171 1.952-3.07 1.952-4.242 0-1.172-1.953-1.172-5.119 0-7.072 1.171-1.952 3.07-1.952 4.242 0 1.172 1.953 1.172 5.119 0 7.072z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 16v-2m8-6h2m-18 0h2m14-4l1.414-1.414M5.414 18.586L4 20m14.142 0l-1.414-1.414M5.414 5.414L4 4" /></svg>`,
            ministerial_regs: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`,
            orders: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>`,
            circulars: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`,
            court_rulings: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            krisdika_rulings: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-5.747-8.994l11.494 0M4.753 12l14.494 0" /></svg>`,
            articles: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>`,
            settings: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
            about: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`
        }
        
        // --- THEME SWITCHER LOGIC ---
        const themes = {
            mint: {
                '--app-bg': '#f0fdfa', '--app-bg-pattern': '#d1fae5', '--sidebar-gradient-start': '#34d399', '--sidebar-gradient-end': '#059669', '--sidebar-text': '#a7f3d0', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#ffffff', '--active-menu-text': '#047857', '--card-bg': '#f0fdfa', '--card-border': '#d1fae5', '--card-text': '#065f46', '--card-hover-bg': '#10b981', '--card-hover-text': '#ffffff', '--card-image-bg': '#a7f3d0', '--button-primary-bg': '#10b981', '--button-primary-hover-bg': '#059669', '--document-hover-border': '#6ee7b7',
            },
            blue: {
                '--app-bg': '#eff6ff', '--app-bg-pattern': '#dbeafe', '--sidebar-gradient-start': '#60a5fa', '--sidebar-gradient-end': '#2563eb', '--sidebar-text': '#dbeafe', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#ffffff', '--active-menu-text': '#1d4ed8', '--card-bg': '#eff6ff', '--card-border': '#dbeafe', '--card-text': '#1e40af', '--card-hover-bg': '#3b82f6', '--card-hover-text': '#ffffff', '--card-image-bg': '#bfdbfe', '--button-primary-bg': '#3b82f6', '--button-primary-hover-bg': '#2563eb', '--document-hover-border': '#93c5fd',
            },
            purple: {
                '--app-bg': '#f5f3ff', '--app-bg-pattern': '#e0e7ff', '--sidebar-gradient-start': '#a78bfa', '--sidebar-gradient-end': '#6d28d9', '--sidebar-text': '#ddd6fe', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#ffffff', '--active-menu-text': '#5b21b6', '--card-bg': '#f5f3ff', '--card-border': '#e0e7ff', '--card-text': '#4c1d95', '--card-hover-bg': '#8b5cf6', '--card-hover-text': '#ffffff', '--card-image-bg': '#c4b5fd', '--button-primary-bg': '#8b5cf6', '--button-primary-hover-bg': '#7c3aed', '--document-hover-border': '#a78bfa',
            },
            pink: {
                '--app-bg': '#fdf2f8', '--app-bg-pattern': '#fce7f3', '--sidebar-gradient-start': '#f472b6', '--sidebar-gradient-end': '#db2777', '--sidebar-text': '#fbcfe8', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#ffffff', '--active-menu-text': '#be185d', '--card-bg': '#fdf2f8', '--card-border': '#fce7f3', '--card-text': '#831843', '--card-hover-bg': '#ec4899', '--card-hover-text': '#ffffff', '--card-image-bg': '#f9a8d4', '--button-primary-bg': '#ec4899', '--button-primary-hover-bg': '#db2777', '--document-hover-border': '#f472b6',
            },
            orange: {
                '--app-bg': '#fff7ed', '--app-bg-pattern': '#ffedd5', '--sidebar-gradient-start': '#fb923c', '--sidebar-gradient-end': '#ea580c', '--sidebar-text': '#fed7aa', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#ffffff', '--active-menu-text': '#c2410c', '--card-bg': '#fff7ed', '--card-border': '#ffedd5', '--card-text': '#7c2d12', '--card-hover-bg': '#f97316', '--card-hover-text': '#ffffff', '--card-image-bg': '#fdba74', '--button-primary-bg': '#f97316', '--button-primary-hover-bg': '#ea580c', '--document-hover-border': '#fb923c',
            },
            classic: {
                '--app-bg': '#f3f4f6', '--app-bg-pattern': '#e5e7eb', '--sidebar-gradient-start': '#6b7280', '--sidebar-gradient-end': '#1f2937', '--sidebar-text': '#d1d5db', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#ffffff', '--active-menu-text': '#111827', '--card-bg': '#f3f4f6', '--card-border': '#e5e7eb', '--card-text': '#1f2937', '--card-hover-bg': '#4b5563', '--card-hover-text': '#ffffff', '--card-image-bg': '#d1d5db', '--button-primary-bg': '#4b5563', '--button-primary-hover-bg': '#374151', '--document-hover-border': '#9ca3af',
            },
            dark: {
                '--app-bg': '#111827', '--app-bg-pattern': '#1f2937', '--sidebar-gradient-start': '#374151', '--sidebar-gradient-end': '#111827', '--sidebar-text': '#9ca3af', '--sidebar-text-hover': '#ffffff', '--active-menu-bg': '#10b981', '--active-menu-text': '#ffffff', '--card-bg': '#1f2937', '--card-border': '#374151', '--card-text': '#d1d5db', '--card-hover-bg': '#10b981', '--card-hover-text': '#ffffff', '--card-image-bg': '#4b5563', '--button-primary-bg': '#10b981', '--button-primary-hover-bg': '#059669', '--document-hover-border': '#10b981',
            }
        };
        
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;

            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
            localStorage.setItem('document_system_theme', themeName);
            updateActiveThemeButton();
        }

        function updateActiveThemeButton() {
            const themeSelector = document.getElementById('theme-selector');
            if (!themeSelector) return;

            const currentTheme = localStorage.getItem('document_system_theme') || 'mint';
            
            themeSelector.querySelectorAll('button').forEach(button => {
                if (button.dataset.theme === currentTheme) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('document_system_theme') || 'mint';
            applyTheme(savedTheme);
        }

        async function fetchData(sheetName) {
            if (WEB_APP_URL === 'ให้ใส่_URL_ของ_WEB_APP_ที่คุณได้มาที่นี่') {
                throw new Error("WEB_APP_URL is not configured.");
            }
            try {
                const url = new URL(WEB_APP_URL);
                url.searchParams.append('sheetName', sheetName);

                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok for sheet: ${sheetName}. Status: ${response.status}`);
                }
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
                return result.data;
            } catch (error) {
                console.error(`Error fetching data for sheet ${sheetName}:`, error);
                showMessage(`ไม่สามารถโหลดข้อมูลชีท ${sheetName} ได้`, 'error');
                throw error; // Re-throw the error to be caught by the caller
            }
        }

        function buildDataStructures(mainMenus, allSubMenus) {
            mainMenuData = mainMenus;
            subMenuData = {};
            
            // Group all sub-menus by their parent ID
            allSubMenus.forEach(item => {
                const parentId = item.parentMenuId;
                if (!subMenuData[parentId]) {
                    subMenuData[parentId] = [];
                }
                subMenuData[parentId].push(item);
            });
        }
        
        function renderSidebar() {
            const mainMenusToRender = mainMenuData.filter(item => item.menuId !== 'settings' && item.menuId !== 'about');
            const staticMenus = mainMenuData.filter(item => item.menuId === 'settings' || item.menuId === 'about');

            let mainNavHtml = '<ul>';
            mainMenusToRender.forEach(item => {
                mainNavHtml += `<li><a href="#" data-content-id="${item.menuId}">${ICONS[item.icon] || ''}<span>${item.menuTitle}</span></a></li>`;
            });
            mainNavHtml += '</ul>';
            
            let bottomNavHtml = '<div class="mt-auto"><ul>';
            staticMenus.forEach(item => {
                bottomNavHtml += `<li><a href="#" data-content-id="${item.menuId}">${ICONS[item.icon] || ''}<span>${item.menuTitle}</span></a></li>`;
            });
            bottomNavHtml += '</ul></div>';
            
            sidebarNavContainer.innerHTML = mainNavHtml + bottomNavHtml;
            
            // Re-attach event listeners after rendering
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const contentId = this.dataset.contentId;
                    historyStack = [contentId]; // Reset history for new top-level section
                    renderContent(contentId);
                    
                    // Close sidebar on mobile after selection
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                });
            });
        }

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        async function renderContent(contentId, isBackNavigation = false) {
            // Update history stack
            if (!isBackNavigation) {
                if (historyStack[historyStack.length - 1] !== contentId) {
                    historyStack.push(contentId);
                }
            }
            
            const currentMainMenuItem = mainMenuData.find(m => m.menuId === contentId);
            const allSubMenus = Object.values(subMenuData).flat();
            const currentSubMenuItem = allSubMenus.find(sm => sm.subMenuId === contentId);
            const title = currentMainMenuItem?.menuTitle || currentSubMenuItem?.subMenuTitle || contentId;
            mainContentTitle.textContent = title;
            updateSidebarActiveLink();

            let htmlContent = '';

            // Add Back button
            if (historyStack.length > 1) {
                htmlContent += `<button id="backButton" class="btn-back"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/></svg><span>ย้อนกลับ</span></button>`;
            }

            // Determine what to render
            if (contentId === 'settings') {
                 htmlContent += `
                    <div class="space-y-6">
                        <div class="setting-item flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-lg text-gray-800">การแจ้งเตือน</h4>
                                <p class="text-gray-500">รับการแจ้งเตือนเมื่อมีเอกสารใหม่</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <h4 class="font-semibold text-lg text-gray-800 mb-3">เลือกธีม</h4>
                            <div id="theme-selector" class="flex flex-wrap gap-3">
                                <button data-theme="mint" class="theme-button px-4 py-2 rounded-lg bg-emerald-500 text-white font-semibold">เขียวมินต์</button>
                                <button data-theme="blue" class="theme-button px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold">น้ำเงิน</button>
                                <button data-theme="purple" class="theme-button px-4 py-2 rounded-lg bg-purple-500 text-white font-semibold">ม่วง</button>
                                <button data-theme="pink" class="theme-button px-4 py-2 rounded-lg bg-pink-500 text-white font-semibold">ชมพู</button>
                                <button data-theme="orange" class="theme-button px-4 py-2 rounded-lg bg-orange-500 text-white font-semibold">ส้ม</button>
                                <button data-theme="classic" class="theme-button px-4 py-2 rounded-lg bg-gray-500 text-white font-semibold">คลาสสิค</button>
                                <button data-theme="dark" class="theme-button px-4 py-2 rounded-lg bg-gray-800 text-white font-semibold">ธีมมืด</button>
                            </div>
                        </div>
                         <div class="setting-item">
                            <h4 class="font-semibold text-lg text-gray-800 mb-2">ภาษา</h4>
                            <select class="w-full p-2 border border-gray-300 rounded-lg">
                                <option>ภาษาไทย</option>
                                <option>English</option>
                            </select>
                        </div>
                    </div>
                 `;
            } else if (contentId === 'about') {
                htmlContent += `
                    <div class="profile-card text-center p-8">
                        <img src="https://placehold.co/120x120/a7f3d0/065f46?text=User" alt="Profile Picture" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                        <h3 class="text-2xl font-bold text-gray-800">พงศธร บุญประเสริฐ</h3>
                        <p class="text-gray-500 font-medium">ผู้ดูแลระบบ</p>
                        <p class="mt-4 text-gray-600 max-w-md mx-auto">
                            ผู้อำนวยการส่วนกำหนดสิทธิในที่ดินและควบคุมทะเบียนที่ดิน สำนักมาตรฐานการทะเบียนที่ดิน กรมที่ดิน
                        </p>
                        <div class="mt-6 flex justify-center space-x-4">
                            <a href="#" class="text-emerald-600 hover:text-emerald-800">อีเมล</a>
                            <a href="#" class="text-emerald-600 hover:text-emerald-800">โทรศัพท์</a>
                            <a href="#" class="text-emerald-600 hover:text-emerald-800">LinkedIn</a>
                        </div>
                    </div>
                `;
            }
            else if (subMenuData[contentId] && subMenuData[contentId].length > 0) {
                // Renders a list of cards (which are sub-menus)
                htmlContent += '<div class="menu-card-grid">';
                subMenuData[contentId].forEach(item => {
                    const imageUrl = item.imageUrl || defaultImageUrl;
                    htmlContent += `
                        <div class="menu-card" data-menu-item="${item.subMenuId}">
                            <div class="menu-card-image-wrapper">
                                <img src="${imageUrl}" alt="${item.subMenuTitle}" class="menu-card-image" onerror="this.onerror=null;this.src='${defaultImageUrl}'">
                            </div>
                            <span class="menu-card-text">${item.subMenuTitle}</span>
                        </div>`;
                });
                htmlContent += '</div>';
            } else {
                // Lazy load documents if not already fetched
                const parentMenuId = historyStack[0];
                const docSheetName = `docs_${parentMenuId}`;
                
                if (!documentData[contentId] && WEB_APP_URL !== 'ให้ใส่_URL_ของ_WEB_APP_ที่คุณได้มาที่นี่') {
                    const docs = await fetchData(docSheetName);
                    if (docs.length > 0) {
                        // Re-organize fetched docs by their parent ID
                        docs.forEach(doc => {
                            if (!documentData[doc.parentSubMenuId]) {
                                documentData[doc.parentSubMenuId] = [];
                            }
                            documentData[doc.parentSubMenuId].push(doc);
                        });
                    }
                }

                if (documentData[contentId]) {
                    // Renders a list of documents
                    htmlContent += `<h3 class="text-xl font-semibold text-gray-700 mb-5">รายการเอกสารสำหรับ ${title}</h3>`;
                    htmlContent += `<div id="documentList" class="space-y-3">`;
                    documentData[contentId].forEach(doc => {
                        htmlContent += `
                            <div class="document-item">
                                <span class="text-gray-800 font-medium">${doc.docName}</span>
                                <button class="btn-read" data-document-link="${doc.docUrl}" data-document-name="${doc.docName}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.816 1.201-2.085 2.4-3.516 3.235C9.879 12.332 8.12 13.5 6 13.5 3.879 12.332 2.121 11.168.827 9.543A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                                    <span>อ่าน</span>
                                </button>
                            </div>`;
                    });
                    htmlContent += `</div>`;
                } else {
                     htmlContent += `<p class="text-gray-600">ยังไม่มีเนื้อหาในหมวดนี้</p>`;
                }
            }
            mainContentDisplay.innerHTML = htmlContent;

            // Attach event listener to back button
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    historyStack.pop();
                    const previousId = historyStack[historyStack.length - 1];
                    renderContent(previousId, true);
                });
            }

            // Attach event listener for "Read" buttons
            const readButtons = document.querySelectorAll('.btn-read');
            readButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const docName = this.dataset.documentName;
                    const docLink = this.dataset.documentLink;
                    showMessage(`กำลังเปิดเอกสาร: ${docName}`, 'success');
                    if (docLink) {
                        window.open(docLink, '_blank');
                    }
                });
            });
            
            // Attach event listener for theme selector
            const themeSelector = document.getElementById('theme-selector');
            if (themeSelector) {
                themeSelector.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON') {
                        const themeName = e.target.dataset.theme;
                        applyTheme(themeName);
                    }
                });
                updateActiveThemeButton();
            }
        }

        function updateSidebarActiveLink() {
            let activeId = 'home'; // Default to 'home'
            if (historyStack.length > 0) {
                // The top-level menu is always the first item in the history stack
                activeId = historyStack[0];
            }

            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                if (link.dataset.contentId === activeId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
        
        async function initApp() {
            loadTheme();
            mainContentDisplay.innerHTML = '<p>กำลังโหลดข้อมูลเมนู...</p>';
            
            try {
                const [mainMenus, subMenus] = await Promise.all([
                    fetchData('MainMenu'),
                    fetchData('SubMenu')
                ]);
                
                if (mainMenus.length > 0 && subMenus.length > 0) {
                    buildDataStructures(mainMenus, subMenus);
                    renderSidebar();
                    renderContent('home');
                } else {
                    throw new Error("ข้อมูลหลัก (MainMenu หรือ SubMenu) ที่ได้รับจาก Google Sheets ว่างเปล่า");
                }
            } catch (error) {
                console.error("Failed to initialize from Google Sheets.", error);
                showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูลจากชีท', 'error');
                mainContentDisplay.innerHTML = '<p class="text-red-500">ผิดพลาด: ไม่สามารถโหลดข้อมูลหลักได้ กรุณาตรวจสอบ URL ของ Web App และชื่อชีท</p>';
            }
        }
        
        // --- EVENT LISTENERS ---
        // Note: 'DOMContentLoaded' is handled by the script type="module" execution flow somewhat, 
        // but 'onAuthStateChanged' is our main trigger now.
        // We do NOT add DOMContentLoaded -> initApp anymore.

        // Event delegation for dynamically created menu cards
        mainContentDisplay.addEventListener('click', function(e) {
            const target = e.target.closest('.menu-card');
            if (target && target.dataset.menuItem) {
                e.preventDefault();
                const clickedMenuItemId = target.dataset.menuItem;
                renderContent(clickedMenuItemId);
            }
        });

    </script>
</body>
</html>
